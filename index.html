<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduQuiz Pro - Real-Time Multiplayer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Poppins:wght@400;700&display=swap');
        
        body { font-family: 'Poppins', sans-serif; background: #0f172a; color: white; overflow-x: hidden; }
        .font-brand { font-family: 'Fredoka', sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .card-shadow { box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        
        .answer-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        .answer-btn { 
            height: 120px; border-radius: 16px; font-size: 2rem; font-weight: bold;
            transition: all 0.2s; border-bottom: 6px solid rgba(0,0,0,0.2);
        }
        .answer-btn:active { transform: translateY(4px); border-bottom-width: 2px; }
        
        .btn-a { background: #ef4444; } .btn-b { background: #3b82f6; }
        .btn-c { background: #f59e0b; } .btn-d { background: #10b981; }

        .hidden-section { display: none !important; }
        .timer-anim { transition: width 1s linear; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- Container Utama -->
    <div id="app" class="w-full max-w-5xl">
        
        <!-- 1. Pemilihan Role -->
        <section id="role-section" class="text-center space-y-8">
            <h1 class="text-5xl font-brand font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600">EduQuiz Pro</h1>
            <p class="text-slate-400">Pilih bagaimana Anda ingin bergabung</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button onclick="selectRole('host')" class="glass p-8 rounded-3xl hover:bg-slate-800 transition group">
                    <div class="text-6xl mb-4 group-hover:scale-110 transition">üñ•Ô∏è</div>
                    <h2 class="text-2xl font-bold">Layar Utama (Host)</h2>
                    <p class="text-sm text-slate-500 mt-2">Gunakan di Proyektor/Laptop untuk menampilkan soal</p>
                </button>
                <button onclick="selectRole('player')" class="glass p-8 rounded-3xl hover:bg-slate-800 transition group">
                    <div class="text-6xl mb-4 group-hover:scale-110 transition">üì±</div>
                    <h2 class="text-2xl font-bold">Pemain (HP)</h2>
                    <p class="text-sm text-slate-500 mt-2">Gunakan di HP masing-masing untuk menjawab</p>
                </button>
            </div>
        </section>

        <!-- 2. Setup (Hanya Host) -->
        <section id="setup-section" class="hidden-section glass p-8 rounded-3xl space-y-6">
            <h2 class="text-3xl font-bold text-center">Konfigurasi Game</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-slate-900">
                <div>
                    <label class="block text-white mb-2">Pilih Kelas</label>
                    <select id="sel-kelas" class="w-full p-3 rounded-xl border-none"><option value="1SD">1 SD</option><option value="10SMA">10 SMA</option></select>
                </div>
                <div>
                    <label class="block text-white mb-2">Mata Pelajaran</label>
                    <select id="sel-mapel" class="w-full p-3 rounded-xl border-none"><option value="MATEMATIKA">Matematika</option><option value="IPA">IPA</option></select>
                </div>
            </div>
            <div class="bg-slate-800 p-4 rounded-2xl">
                <p class="text-center text-cyan-400 font-bold mb-2">KODE RUANGAN: <span id="display-room-code" class="text-3xl tracking-widest text-white">------</span></p>
            </div>
            <button onclick="initHostGame()" class="w-full bg-blue-600 p-4 rounded-xl font-bold text-xl hover:bg-blue-500">Mulai Sesi (Tunggu Pemain)</button>
        </section>

        <!-- 3. Join (Hanya Pemain) -->
        <section id="join-section" class="hidden-section glass p-8 rounded-3xl text-center space-y-6">
            <h2 class="text-3xl font-bold">Gabung Kuis</h2>
            <input id="join-name" type="text" placeholder="Nama Kamu" class="w-full p-4 rounded-xl bg-slate-800 text-white border border-slate-700 outline-none">
            <input id="join-room" type="text" placeholder="Kode Ruangan" class="w-full p-4 rounded-xl bg-slate-800 text-white border border-slate-700 outline-none uppercase text-center font-bold tracking-widest">
            <button onclick="joinAsPlayer()" class="w-full bg-green-600 p-4 rounded-xl font-bold">GABUNG SEKARANG</button>
        </section>

        <!-- 4. Screen HOST (Layar Besar) -->
        <section id="host-game-screen" class="hidden-section space-y-8">
            <div class="flex justify-between items-end">
                <div class="space-y-1">
                    <h3 id="host-mapel" class="text-cyan-400 font-bold uppercase tracking-wider">MAPEL</h3>
                    <h2 id="host-question" class="text-4xl font-bold leading-tight max-w-3xl">Memuat Pertanyaan...</h2>
                </div>
                <div class="text-center">
                    <div id="host-timer" class="text-6xl font-brand text-orange-500">30</div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="p-6 rounded-2xl bg-red-500/20 border border-red-500 text-xl font-bold">A. <span id="opt-a">Pilihan A</span></div>
                <div class="p-6 rounded-2xl bg-blue-500/20 border border-blue-500 text-xl font-bold">B. <span id="opt-b">Pilihan B</span></div>
                <div class="p-6 rounded-2xl bg-amber-500/20 border border-amber-500 text-xl font-bold">C. <span id="opt-c">Pilihan C</span></div>
                <div class="p-6 rounded-2xl bg-emerald-500/20 border border-emerald-500 text-xl font-bold">D. <span id="opt-d">Pilihan D</span></div>
            </div>

            <div class="glass p-6 rounded-3xl">
                <h4 class="text-sm font-bold text-slate-500 mb-4 uppercase">Papan Skor Real-Time</h4>
                <div id="host-leaderboard" class="space-y-2"></div>
            </div>
        </section>

        <!-- 5. Screen PLAYER (HP Kontrol) -->
        <section id="player-game-screen" class="hidden-section text-center space-y-8">
            <div class="flex justify-between items-center">
                <span id="player-display-name" class="font-bold text-slate-400">Nama Pemain</span>
                <span id="player-display-score" class="bg-indigo-600 px-4 py-1 rounded-full text-sm font-bold">Skor: 0</span>
            </div>
            
            <div id="player-waiting-msg" class="text-2xl font-bold py-20 text-slate-500">Menunggu Soal Berikutnya...</div>
            
            <div id="player-controls" class="hidden-section answer-grid">
                <button onclick="submitAnswer(0)" class="answer-btn btn-a">A</button>
                <button onclick="submitAnswer(1)" class="answer-btn btn-b">B</button>
                <button onclick="submitAnswer(2)" class="answer-btn btn-c">C</button>
                <button onclick="submitAnswer(3)" class="answer-btn btn-d">D</button>
            </div>
        </section>

    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD--Q5M0AwnbQsr85y91dgeaYXox03fi6M",
            authDomain: "gameseru-ed903.firebaseapp.com",
            projectId: "gameseru-ed903",
            storageBucket: "gameseru-ed903.firebasestorage.app",
            messagingSenderId: "289883987670",
            appId: "1:289883987670:web:ca1f4aa8d328947fd3b377"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = "edu-pro-realtime-v1";

        let localState = {
            role: null,
            roomCode: null,
            userId: null,
            userName: '',
            score: 0,
            currentQuestion: null,
            isLocked: false
        };

        // --- UTIL: Generator Soal ---
        function generateFakeQuestions(count) {
            const subjects = ["IPA", "IPS", "MATEMATIKA", "SEJARAH"];
            const data = [];
            for(let i=1; i<=count; i++) {
                data.push({
                    q: `Pertanyaan Nomor ${i}: Berapakah 100 x ${i}?`,
                    a: [`${100*i}`, `${100*i+1}`, `${100*i-1}`, `${100*i+10}`],
                    c: 0
                });
            }
            return data;
        }

        // --- UI NAVIGATION ---
        window.selectRole = (role) => {
            localState.role = role;
            document.getElementById('role-section').classList.add('hidden-section');
            if(role === 'host') {
                localState.roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                document.getElementById('display-room-code').innerText = localState.roomCode;
                document.getElementById('setup-section').classList.remove('hidden-section');
            } else {
                document.getElementById('join-section').classList.remove('hidden-section');
            }
        };

        // --- HOST LOGIC ---
        window.initHostGame = async () => {
            await signInAnonymously(auth);
            const questions = generateFakeQuestions(50);
            
            // Buat dokumen room di Firebase
            const roomRef = doc(db, 'artifacts', appId, 'public', 'rooms', localState.roomCode);
            await setDoc(roomRef, {
                status: 'waiting',
                currentIdx: 0,
                timer: 30,
                question: questions[0],
                active: true,
                createdAt: Date.now()
            });

            document.getElementById('setup-section').classList.add('hidden-section');
            document.getElementById('host-game-screen').classList.remove('hidden-section');
            
            // Listen Players
            listenPlayers();
            // Start Game Loop
            startHostLoop(roomRef, questions);
        };

        function startHostLoop(ref, questions) {
            let idx = 0;
            let time = 30;

            const interval = setInterval(async () => {
                time--;
                document.getElementById('host-timer').innerText = time;
                
                if(time <= 0) {
                    idx++;
                    if(idx >= questions.length) {
                        clearInterval(interval);
                        alert("Kuis Selesai!");
                        return;
                    }
                    time = 30;
                    const nextQ = questions[idx];
                    await updateDoc(ref, { currentIdx: idx, question: nextQ, timer: 30 });
                    updateHostUI(nextQ);
                }
            }, 1000);

            updateHostUI(questions[0]);
        }

        function updateHostUI(q) {
            document.getElementById('host-question').innerText = q.q;
            document.getElementById('opt-a').innerText = q.a[0];
            document.getElementById('opt-b').innerText = q.a[1];
            document.getElementById('opt-c').innerText = q.a[2];
            document.getElementById('opt-d').innerText = q.a[3];
        }

        function listenPlayers() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'rooms', localState.roomCode, 'players'), (snap) => {
                const players = [];
                snap.forEach(d => players.push(d.data()));
                players.sort((a,b) => b.score - a.score);
                
                document.getElementById('host-leaderboard').innerHTML = players.map(p => `
                    <div class="flex justify-between items-center p-3 bg-slate-800 rounded-xl">
                        <span>${p.name}</span>
                        <span class="font-bold text-cyan-400">${p.score} Poin</span>
                    </div>
                `).join('');
            });
        }

        // --- PLAYER LOGIC ---
        window.joinAsPlayer = async () => {
            const name = document.getElementById('join-name').value;
            const room = document.getElementById('join-room').value.toUpperCase();
            if(!name || !room) return alert("Isi data!");

            await signInAnonymously(auth);
            localState.userId = auth.currentUser.uid;
            localState.roomCode = room;
            localState.userName = name;

            const roomRef = doc(db, 'artifacts', appId, 'public', 'rooms', room);
            const roomSnap = await getDoc(roomRef);
            
            if(!roomSnap.exists()) return alert("Ruangan tidak ditemukan!");

            await setDoc(doc(db, 'artifacts', appId, 'public', 'rooms', room, 'players', localState.userId), {
                name: name, score: 0
            });

            document.getElementById('join-section').classList.add('hidden-section');
            document.getElementById('player-game-screen').classList.remove('hidden-section');
            document.getElementById('player-display-name').innerText = name;

            // Listen to Room Changes
            onSnapshot(roomRef, (snap) => {
                const data = snap.data();
                if(localState.currentQuestion !== data.currentIdx) {
                    localState.currentQuestion = data.currentIdx;
                    localState.isLocked = false;
                    document.getElementById('player-controls').classList.remove('hidden-section');
                    document.getElementById('player-waiting-msg').classList.add('hidden-section');
                    localState.correctAnswer = data.question.c;
                }
            });
        };

        window.submitAnswer = async (idx) => {
            if(localState.isLocked) return;
            localState.isLocked = true;
            
            document.getElementById('player-controls').classList.add('hidden-section');
            document.getElementById('player-waiting-msg').classList.remove('hidden-section');
            document.getElementById('player-waiting-msg').innerText = "Jawaban Terkunci...";

            if(idx === localState.correctAnswer) {
                localState.score += 10;
                document.getElementById('player-display-score').innerText = `Skor: ${localState.score}`;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'rooms', localState.roomCode, 'players', localState.userId), {
                    score: localState.score
                });
            }
        };

    </script>
</body>
</html>

